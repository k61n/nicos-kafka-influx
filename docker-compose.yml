
services:
  influxdb:
    image: influxdb:alpine
    container_name: nicos-influxdb
    networks:
      - nicos_network
    ports:
      - "8086:8086"
    environment: 
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=nicos
      - DOCKER_INFLUXDB_INIT_PASSWORD=password
      - DOCKER_INFLUXDB_INIT_ORG=mlz
      - DOCKER_INFLUXDB_INIT_BUCKET=nicos-cache
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=token_for_tests

  kafka:
    image: docker.io/bitnami/kafka:latest
    container_name: nicos-kafka
    networks:
      - nicos_network
    ports:
      - "9092:9092"
    environment:
      - KAFKA_CFG_NODE_ID=0
      - KAFKA_CFG_PROCESS_ROLES=controller,broker
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://:9092
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@localhost:9093

  init-kafka:
    image: docker.io/bitnami/kafka:latest
    container_name: nicos-kafka-init
    depends_on:
      - kafka
    networks:
      - nicos_network
    entrypoint: [ '/bin/sh', '-c' ]
    command: |
      "
      kafka-topics.sh --create --topic test-flatbuffers --bootstrap-server nicos-kafka:9092
      kafka-topics.sh --create --topic test-flatbuffers-history --bootstrap-server nicos-kafka:9092
      "

  nicos:
    build:
      context: ./nicos
      dockerfile: Dockerfile
    image: nicos:latest
    container_name: nicos
    depends_on:
      - influxdb
      - kafka
    networks:
      - nicos_network
    ports:
      - "1301:1301"
    environment: 
      - INFLUXDB_URI=http://nicos-influxdb:8086
      - INFLUXDB_TOKEN=token_for_tests
      - KAFKA_URI=nicos-kafka:9092
      - NICOS_TEST_ROOT=/home/nicos/test/
    user: nicos
#    volumes:
#      - /Users/kk/work/nicos/nicos:/home/nicos/nicos
    entrypoint: [ '/bin/bash', '-c' ]
    command: |
        "
        sleep 1
        git config --global --add safe.directory /home/nicos/nicos
        ./nicos/bin/nicos-keystore add influxdb --storagepw nicos --password $$INFLUXDB_TOKEN
        entrypoint.sh
        "

networks:
  nicos_network:
